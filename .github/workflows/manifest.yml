name: Build posts manifest

on:
  push:
    paths:
      - 'content/posts/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate content/posts/index.json
        shell: bash
        run: |
          set -euo pipefail
          node -e "
          const fs=require('fs');
          const path=require('path');
          const p='content/posts';
          if(!fs.existsSync(p)) process.exit(0);
          const files=fs.readdirSync(p).filter(f=>f.endsWith('.md'));
          const items=files.map(f=>{
            const full=path.join(p,f);
            const s=fs.readFileSync(full,'utf8');
            const m=(/^title:\\s*(.*)$/m.exec(s)||[])[1]||f;
            return { slug:f.replace(/\\.md$/, ''), title:m };
          });
          fs.writeFileSync(path.join(p,'index.json'), JSON.stringify(items, null, 2));
          "
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update posts manifest"
      - name: Purge jsDelivr cache
        run: |
          curl -s "https://purge.jsdelivr.net/gh/tegarnugroho/personal-blog@main/content/posts/index.json"
